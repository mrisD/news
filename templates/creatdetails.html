<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>创建抓取配置</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">创建抓取配置</h1>

        <!-- 标签卡导航 -->
        <ul class="nav nav-tabs" id="configTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="start-tab" data-bs-toggle="tab" data-bs-target="#start" type="button" role="tab" aria-controls="start" aria-selected="true">起始配置</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab" aria-controls="list" aria-selected="false">列表页配置</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail" type="button" role="tab" aria-controls="detail" aria-selected="false">详情页配置</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="task-tab" data-bs-toggle="tab" data-bs-target="#task" type="button" role="tab" aria-controls="task" aria-selected="false">定时任务配置</button>
            </li>
        </ul>

        <!-- 标签卡内容 -->
        <div class="tab-content mt-4" id="configTabsContent">
            <!-- 起始配置 -->
            <div class="tab-pane fade show active" id="start" role="tabpanel" aria-labelledby="start-tab">
                <form id="startConfigForm">
                    <div class="mb-3">
                        <label for="pzname" class="form-label">配置名称</label>
                        <input type="text" class="form-control" id="pzname" required>
                    </div>
                    <div class="mb-3">
                        <label for="spidername" class="form-label">spidername</label>
                        <input type="text" class="form-control" id="spidername" required>
                    </div>
                    <div class="mb-3">
                        <label for="startUrl" class="form-label">起始 URL</label>
                        <input type="url" class="form-control" id="startUrl" required>
                        <small class="form-text text-danger d-none" id="urlError">请输入有效的 URL</small>
                    </div>
                    <div class="mb-3">
                        <label for="pages" class="form-label">页数</label>
                        <input type="number" class="form-control" id="pages" required min="1">
                        <small class="form-text text-danger d-none" id="pagesError">页数必须大于等于 1</small>
                    </div>
                    <div class="mb-3">
                        <label for="requestMethod" class="form-label">请求方式</label>
                        <select class="form-select" id="requestMethod" required>
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                        </select>
                    </div>
                </form>
            </div>

            <!-- 列表页配置 -->
            <div class="tab-pane fade" id="list" role="tabpanel" aria-labelledby="list-tab">
                <form id="listConfigForm">
                    <div class="mb-3">
                        <label for="listdatatype" class="form-label">列表页数据类型</label>
                        <select class="form-select" id="listdatatype" required>
                            <option value="html">html</option>
                            <option value="json">json</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="xpathFieldsList" class="form-label">列表页字段 XPath</label>
                        <textarea class="form-control" id="xpathFieldsList" rows="3" required></textarea>
                        <small class="form-text text-muted">每行一个 XPath</small>
                    </div>
                </form>
            </div>

            <!-- 详情页配置 -->
            <div class="tab-pane fade" id="detail" role="tabpanel" aria-labelledby="detail-tab">
                <form id="detailConfigForm">
                    <div class="mb-3">
                        <label for="detaildatatype" class="form-label">详情页数据类型</label>
                        <select class="form-select" id="detaildatatype" required>
                            <option value="html">html</option>
                            <option value="json">json</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="xpathFieldsDetail" class="form-label">详情页字段 XPath</label>
                        <textarea class="form-control" id="xpathFieldsDetail" rows="3" required></textarea>
                        <small class="form-text text-muted">每行一个 XPath</small>
                    </div>
                </form>
            </div>

            <!-- 定时任务配置 -->
            <div class="tab-pane fade" id="task" role="tabpanel" aria-labelledby="task-tab">
                <form id="taskConfigForm">
                    <div class="mb-3">
                        <label for="tasktime" class="form-label">定时任务</label>
                        <textarea class="form-control" id="tasktime" rows="3" required></textarea>
                        <small class="form-text text-muted">每行一个定时任务，例如：<code>0 0 * * *</code>（每天午夜运行）</small>
                    </div>
                </form>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="text-center mt-4">
            <button type="button" class="btn btn-secondary" onclick="window.history.back()">取消</button>
            <button type="button" class="btn btn-primary" id="saveConfigButton">保存配置</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>


        // 页面加载时获取配置数据并填充表单
    window.onload = function() {
        const crawlerId = window.location.pathname.split('/').pop();

        // 获取爬虫配置数据
        fetch(`/api/crawlers/${crawlerId}`)
            .then(response => response.json())
            .then(data => {
                if (data.data && data.data.new_config) {
                    const newConfig = data.data.new_config;

                    // 填充起始配置表单
                    document.getElementById('pzname').value = newConfig.pzname || '';
                    document.getElementById('spidername').value = newConfig.spidername || '';
                    document.getElementById('startUrl').value = newConfig.start_url || '';
                    document.getElementById('pages').value = newConfig.pages || '';
                    document.getElementById('requestMethod').value = newConfig.request_method || 'GET';

                    // 填充列表页配置表单
                    document.getElementById('listdatatype').value = newConfig.listdatatype || 'html';
                    document.getElementById('xpathFieldsList').value = newConfig.xpathFieldsList.join('\n') || '';

                    // 填充详情页配置表单
                    document.getElementById('detaildatatype').value = newConfig.detaildatatype || 'html';
                    document.getElementById('xpathFieldsDetail').value = newConfig.xpathFieldsDetail.join('\n') || '';

                    // 填充定时任务配置表单
                    document.getElementById('tasktime').value = newConfig.tasktime.join('\n') || '';
                }
            })
            .catch(error => {
                console.error('Error fetching crawler data:', error);
                alert('加载配置失败，请稍后重试');
            });
    };




        document.getElementById('saveConfigButton').addEventListener('click', function () {
            // 起始配置

            const pzname = document.getElementById('pzname').value;
            const spidername = document.getElementById('spidername').value;
            const startUrl = document.getElementById('startUrl').value;
            const pages = document.getElementById('pages').value;
            const requestMethod = document.getElementById('requestMethod').value;

            // 列表页配置
            const listdatatype = document.getElementById('listdatatype').value;
            const xpathFieldsList = document.getElementById('xpathFieldsList').value.split('\n');

            // 详情页配置
            const detaildatatype = document.getElementById('detaildatatype').value;
            const xpathFieldsDetail = document.getElementById('xpathFieldsDetail').value.split('\n');

            // 定时任务配置
            const tasktime = document.getElementById('tasktime').value.split('\n');

            // 汇总配置数据
            const newConfig = {
                pzname:pzname,
                spidername:spidername,
                start_url: startUrl,
                pages: parseInt(pages),
                request_method: requestMethod,
                listdatatype: listdatatype,
                xpathFieldsList: xpathFieldsList,
                detaildatatype: detaildatatype,
                xpathFieldsDetail: xpathFieldsDetail,
                tasktime: tasktime,
            };

            console.log('配置数据：', newConfig);
            // 从 URL 中提取 _id
        const crawlerId = window.location.pathname.split('/').pop();
        // 获取 _id

        // 发送 PUT 请求将新配置添加到现有 config 字段中
        fetch(`/api/crawlers/${crawlerId}`, {
            method: 'PUT', // 或者 PATCH，根据后端需求调整
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: "add_config", // 发送一个动作参数，让后端明确操作
                new_config: newConfig,
            }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Crawler updated successfully") {
                    alert('配置已成功添加');
                    window.location.href = `/config-details/${crawlerId}`;
                } else {
                    alert("保存失败：${data.message}");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('网络错误，请稍后重试');
            });
        });
    </script>
</body>
</html>
