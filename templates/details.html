<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置详情</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1>配置详情</h1>
        <table class="table table-bordered">
            <tr>
                <th>栏目ID</th>
                <td>{{ config._id }}</td>
            </tr>
            <tr>
                <th>配置名称</th>
                <td>{{ config.name }}</td>
            </tr>
            <tr>
                <th>创建时间</th>
                <td>{{ config.created_time }}</td>
            </tr>
            <tr>
                <th>创建人</th>
                <td>{{ config.creator }}</td>
            </tr>
            <tr>
                <th>最后修改时间</th>
                <td>{{ config.modified_time }}</td>
            </tr>
            <tr>
                <th>资源链接</th>
                <td>
                    <a href="http{{ 's' if config.resource_link.startswith('https') else '' }}://{{ config.resource_link }}" target="_blank">
                        {{ config.resource_link }}
                    </a>
                </td>
            </tr>

        </table>
        <div class="mt-3">
            <!-- 返回按钮 -->
            <button class="btn btn-secondary" onclick="window.history.back()">返回</button>
            <!-- 创建抓取配置按钮 -->

            <a id="createConfigLink" class="btn btn-primary">创建抓取配置</a>

        </div>
    </div>




    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // 从 URL 中提取 _id 参数
    function getCrawlerIdFromUrl() {
        const url = window.location.href; // 获取当前页面 URL
        const segments = url.split('/'); // 按斜杠分割 URL
        return segments[segments.length - 1]; // 提取最后一段作为 _id
    }
    // 动态设置创建抓取配置按钮的链接
    document.addEventListener('DOMContentLoaded', function () {
        const crawlerId = getCrawlerIdFromUrl(); // 获取当前页面的 ID
        const createConfigLink = document.getElementById('createConfigLink'); // 获取按钮元素
        if (createConfigLink) {
            createConfigLink.href = `/create-config/${crawlerId}`; // 动态设置 href
        }
    });
    // 初始化模态框
    const modal = new bootstrap.Modal(document.getElementById('createConfigModal'));

    // 打开模态框
    document.getElementById('createConfigBtn').addEventListener('click', function () {
        modal.show();
    });

    // 表单校验函数
    function validateForm() {
        let isValid = true;

        // 校验 URL
        const url = document.getElementById('startUrl').value;
        const urlError = document.getElementById('urlError');
        const urlRegex = /^(https?:\/\/)?([\w\-]+\.)+[a-z]{2,}(\/[\w\-./?%&=]*)?$/i;
        if (!urlRegex.test(url)) {
            urlError.classList.remove('d-none');
            isValid = false;
        } else {
            urlError.classList.add('d-none');
        }

        // 校验页数
        const pages = document.getElementById('pages').value;
        const pagesError = document.getElementById('pagesError');
        if (parseInt(pages) < 1) {
            pagesError.classList.remove('d-none');
            isValid = false;
        } else {
            pagesError.classList.add('d-none');
        }

        return isValid;
    }

    // 保存配置
    document.getElementById('saveConfigBtn').addEventListener('click', function () {
        if (!validateForm()) {
            return; // 如果表单无效，停止提交
        }

        // 获取表单数据
        const startUrl = document.getElementById('startUrl').value;
        const pages = document.getElementById('pages').value;
        const requestMethod = document.getElementById('requestMethod').value;
        const listdatatype = document.getElementById('listdatatype').value;
        const detaildatatype= document.getElementById('detaildatatype').value;
        const xpathFieldsList = document.getElementById('xpathFieldsList').value.split('\n');
        const xpathFieldsDetail = document.getElementById('xpathFieldsDetail').value.split('\n');
        const tasktime = document.getElementById('tasktime').value.split('\n');
        // 准备要追加的配置数据
        const newConfig = {
            start_url: startUrl,
            pages: parseInt(pages),
            request_method: requestMethod,
            listdatatype:listdatatype,
            xpathFieldsList: xpathFieldsList,
            detaildatatype:detaildatatype,
            xpathFieldsDetail:xpathFieldsDetail,
            tasktime:tasktime,
        };

        // 获取 _id
        const crawlerId = getCrawlerIdFromUrl();

        // 发送 PUT 请求将新配置添加到现有 config 字段中
        fetch(`/api/crawlers/${crawlerId}`, {
            method: 'PUT', // 或者 PATCH，根据后端需求调整
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: "add_config", // 发送一个动作参数，让后端明确操作
                new_config: newConfig,
            }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Crawler updated successfully") {
                    alert('配置已成功添加');
                    // 更新页面显示（如果有必要刷新整个页面）
                    window.location.reload();
                } else {
                    alert(`保存失败：${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('网络错误，请稍后重试');
            });

        // 清空表单并关闭模态框
        document.getElementById('createConfigForm').reset();
        modal.hide();
    });
</script>

</body>
</html>